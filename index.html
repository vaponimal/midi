<!DOCTYPE html>
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Music Theory Trainer</title>
    <meta name="theme-color" content="#0b1130" />
    <style>
        :root {
            --bg: #0a0d1a;
            --panel: #0f1430;
            --panel-2: #151a3a;
            --ink: #e8ecff;
            --muted: #9fb0ff;
            --accent: #7c9cff;
            --accent-2: #94f1ff;
            --good: #72f3b6;
            --bad: #ff6b7a;
            --warn: #ffd166;
            --key: #eeeeee;
            --key-black: #0e0e17;
            --key-edge: #a5a5a5;
            --shadow: 0 10px 30px rgba(0, 0, 0, .35);
            --dot: #ff6578;
            --mark: #7c9cff;
        }

        * {
            box-sizing: border-box
        }

        html,
        body {
            height: 100%
        }

        body {
            margin: 0;
            background: radial-gradient(1200px 800px at 80% -10%, #2f356f33 0%, transparent 60%), radial-gradient(1200px 800px at 10% 110%, #2f356f33 0%, transparent 60%), linear-gradient(160deg, #0a0d1a 0%, #0b1130 60%, #0a0d1a 100%);
            color: var(--ink);
            font: 1.125rem/1.5 system-ui, Segoe UI, Roboto, Helvetica, Arial, Apple Color Emoji, Segoe UI Emoji;
        }



        header {
            display: flex;
            align-items: center;
            gap: 1.125rem;
            padding: 14px 10.5rem;
            border-bottom: 1px solid #232853;
            background: linear-gradient(180deg, rgba(255, 255, 255, .06), transparent);
            position: sticky;
            top: 0;
            z-index: 50;
            backdrop-filter: saturate(140%) blur(6px);
            justify-content: space-between;

        }

        .navigation {
            z-index: 100;
            display: block;
            justify-content: space-between;
        }

        .logo {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: conic-gradient(from 220deg, var(--accent), var(--accent-2));
            display: grid;
            place-items: center;
            box-shadow: 0 4px 20px rgba(124, 156, 255, .45)
        }

        .logo:before {
            content: "‚ô™";
            font-size: 20px;
            color: #0b1130;
            filter: drop-shadow(0 2px 2px rgba(255, 255, 255, .3))
        }

        h1 {
            margin: 0;
            font-size: 1.6rem;
            letter-spacing: 0;
        }

        .subtitle {
            color: var(--muted);
            font-size: 1rem;
        }

        /* Layout: Top (controls) + Bottom (piano) */
        .top {
            position: sticky;
            /* top: 56px; */
            z-index: 40;
            background: linear-gradient(180deg, var(--panel) 0%, var(--panel-2) 100%);
            border-bottom: 1px solid #253082;
            box-shadow: var(--shadow)
        }

        .top-inner {
            max-width: 1200px;
            margin: 0 auto;
            padding: 1em;
            display: flex;
            flex-direction: column;
            gap: 1em;
            align-items: center;
        }

        .controls {
            display: flex;
            flex-wrap: wrap;
            /* gap: 0.5rem; */
            align-items: center
        }

        .row {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-bottom: 0.5em;
            align-items: center
        }

        label {
            font-size: 1rem;
            color: var(--muted)
        }

        select,
        button,
        input[type="number"],
        input[type="range"] {
            background: #0f1747;
            color: var(--ink);
            border: 1px solid #3340a6;
            border-radius: 0.5rem;
            padding: 0.5rem 1rem;
            font-size: 1rem;
        }

        .pill {
            background: #0f1747;
            color: var(--ink);
            border-radius: 0.5rem;
            padding: 0.5rem 1rem;
            font-size: 1rem;
            display: inline-flex;
            gap: 1rem;
            align-items: center;
            justify-content: center;
            min-width: 4em;
        }

        .pilltransparent {
            /* background: #0f1747;
            color: var(--ink);
            border: 1px solid #3340a6;
            border-radius: 0.5rem; */
            padding: 0.3rem 0.7rem;
            font-size: 1rem;
        }

        .pilltransparent {
            display: inline-flex;
            gap: 1rem;
            align-items: center
        }

        button {
            cursor: pointer
        }

        button.primary {
            background: linear-gradient(180deg, var(--accent) 0%, #5877ff 100%);
            color: #0a0d1a;
            border: none;
            font-weight: 600;
            padding: 0.75rem 1rem;
        }

        .tabs {
            display: flex;
            gap: 6px;
            flex-wrap: wrap
        }

        .tab {
            min-width: 120px;
            text-align: center;
            background: #121840;
            color: var(--ink);
            border: 1px solid #2a348c;
            border-radius: 12px;
            padding: 0.5rem 10px;
            cursor: pointer;
            user-select: none;
        }

        .tab.active {
            outline: 2px solid var(--accent);
            box-shadow: 0 0 0 3px #7c9cff22 inset
        }

        .panel {
            max-width: 100vw;
            margin: 0.5rem auto;
            padding: 0 1.125rem
        }

        .section {
            margin-top: 10px;
            padding: 10px;
            border: 1px dashed #2a3380;
            border-radius: 12px;
            background: linear-gradient(180deg, rgba(255, 255, 255, .02), transparent)
        }

        .section-cont {
            display: flex;
            justify-content: space-between
        }

        .section h3 {
            margin: 6px 0 0.5rem
        }

        /* Bottom: Piano */
        .piano-wrap {
            max-width: 100vw;
            margin: 10px auto 24px;
            padding: 0 1.125rem
        }

        .piano-toolbar {
            display: flex;
            justify-content: space-between;
            gap: 0.5rem;
            margin-bottom: 0.5rem
        }

        .piano-viewport {
            width: 100%;
            background: linear-gradient(180deg, #0b122e 0%, #0a0d1a 100%);
            border: 1px solid #2a3380;
            border-radius: 1.125rem;
            padding: 12px;
            overflow-x: auto;
            white-space: nowrap
        }

        .piano {
            width: 100%;
            max-width: 100%;
            position: relative;
            user-select: none;
            height: 300px;
            display: block
        }

        /* white keys will be sized in JS so they fill the viewport when <=37 white keys */
        .white {
            position: relative;
            display: inline-block;
            height: calc(100% - 1.125rem);
            background: linear-gradient(180deg, var(--key) 0%, #d3d6e7 80%);
            border: 1px solid var(--key-edge);
            border-bottom: 6px solid #747474;
            border-radius: 4px 4px 0.5rem 0.5rem;
            box-shadow: inset 0 -20px 10px rgba(0, 0, 0, .05);
            vertical-align: top;
            z-index: 1
        }

        .white.active {
            background: linear-gradient(180deg, #ffffff 0%, #eff3ff 100%);
            border-bottom: 6px solid var(--key-edge);
            /* outline: 2px solid var(--accent) */
        }

        .label {
            position: absolute;
            bottom: 0.5rem;
            left: 0;
            right: 0;
            text-align: center;
            font-size: 12px;
            color: #5c63a3;
            pointer-events: none
        }

        .label.bold {
            font-weight: 800;
            color: var(--mark)
        }

        .black {
            position: absolute;
            height: 60%;
            background: linear-gradient(180deg, #22253d 0%, var(--key-black) 100%);
            border: 1px solid #0b0b13;
            border-bottom: 6px solid #0a0a12;
            border-radius: 0 0 6px 6px;
            box-shadow: inset 0 -24px 0.5rem rgba(255, 255, 255, .04);
            z-index: 3
        }

        .black.active {
            /* outline: 2px solid var(--accent-2) */
            background: #353549;
            border-bottom: 6px solid #3c3c42;


        }

        .note-dot {
            position: absolute;
            top: 6px;
            left: 50%;
            transform: translateX(-50%);
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: var(--dot);
            box-shadow: 0 0 0 4px rgba(255, 101, 120, .18)
        }

        /* 
        .highlight {
            box-shadow: 0 0 0 3px rgba(124, 156, 255, .45) inset
        } */

        .kbd-map {
            margin-top: 0.5rem;
            color: var(--muted);
            font-size: 12px
        }

        .float-notes {
            position: fixed;
            inset: 0;
            pointer-events: none;
            overflow: hidden;
            z-index: 0
        }

        .float-notes span {
            position: absolute;
            color: #5f79ff44;
            font-size: 20px;
            animation: rise 12s linear infinite
        }

        @keyframes rise {
            from {
                transform: translateY(120vh) rotate(0deg)
            }

            to {
                transform: translateY(-10vh) rotate(180deg)
            }
        }

        .error-toast {
            position: fixed;
            left: 50%;
            top: 10.5rem;
            transform: translateX(-50%);
            background: #ffdfe3;
            color: #2c020a;
            border: 1px solid #ff9fb0;
            padding: 0.5rem 12px;
            border-radius: 12px;
            z-index: 200;
            box-shadow: var(--shadow)
        }
    </style>
</head>

<body>
    <div class="float-notes" id="floatNotes"></div>
    <header>
        <!-- <div class="navigation" aria-label="Main Navigation"> -->
        <!-- <div class="pilltransparent">
            <div class="logo" aria-hidden="true"></div>
            <div>
                <h1>Virtual MIDI Keyboard</h1>
                <div class="subtitle">Learn notes, scales, chords ‚Äî and train your ears with a playful keyboard.</div>
            </div>
        </div> -->

        <!-- PANEL TOP -->
        <div class="tabs" role="tablist">
            <div class="tab active" data-tab="notes" role="tab" aria-selected="true">üéπ Notes</div>
            <div class="tab" data-tab="scales" role="tab">üìà Scales</div>
            <div class="tab" data-tab="chords" role="tab">üéº Chords</div>
            <div class="tab" data-tab="ear" role="tab">üëÇ Ear Training</div>
            <div class="tab" data-tab="demo" role="tab">üéµ Demo Songs</div>
        </div>
        <!-- </div> -->
    </header>

    <!-- TOP PANELS CONTENT -->
    <main class="panel">
        <section class="section" id="panel-notes">
            <h3>Note Explorer</h3>
            <div class="row" style="margin-top:0.5rem;color:var(--muted)"> Details about the selected note.
            </div>
            <div class="section-cont">
                <div class="row" style="margin-top:0.5rem">
                    <div class="pill">Current: <b id="currentNote">‚Äî</b></div>
                    <div class="pill">Hz: <b id="currentHz">‚Äî</b></div>
                    <div class="pill">MIDI: <b id="currentMidi">‚Äî</b></div>
                </div>
                <div class="row">
                    <label for="noteSelect">Play note</label>
                    <select id="noteSelect"></select>
                    <span><span style="opacity:.7">Octave</span>
                        <select id="octaveSelect"></select>
                    </span>
                    <button id="playNote" class="primary">Play</button>
                </div>
            </div>
        </section>

        <section class="section" id="panel-scales" style="display:none">
            <h3>Scale Visualizer</h3>
            <div class="row" style="margin-top:0.5rem;color:var(--muted)"> Scales by piano keys, for music theory needs.
            </div>
            <div class="section-cont">
                <div class="row" style="margin-top:0.5rem"><span class="pill" id="scaleFormula">Formula: ‚Äî</span>
                </div>
                <div class="row">
                    <label>Root</label>
                    <select id="scaleRoot"></select>
                    <label>Type</label>
                    <select id="scaleType"></select>
                    <label>Direction</label>
                    <select id="scaleDir">
                        <option value="up">Low ‚Üí High</option>
                        <option value="down">High ‚Üí Low</option>
                        <option value="updown">Low ‚Üí High ‚Üí Low</option>
                    </select>
                    <button id="playScale" class="primary">Play Scale</button>
                </div>
            </div>
        </section>

        <section class="section" id="panel-chords" style="display:none">
            <h3>Chord Builder</h3>
            <div class="row" style="margin-top:0.5rem;color:var(--muted)">Chords by piano keys, for music theory needs.
            </div>
            <div class="section-cont">
                <div class="row" style="margin-top:0.5rem"><span class="pill" id="chordFormula">Intervals: ‚Äî</span>
                </div>
                <div class="row">
                    <label>Root</label>
                    <select id="chordRoot"></select>
                    <label>Quality</label>
                    <select id="chordType"></select>
                    <label>Playback</label>
                    <select id="chordPlay">
                        <option value="block">Block (together)</option>
                        <option value="up">Arpeggiate ‚Üë</option>
                        <option value="down">Arpeggiate ‚Üì</option>
                    </select>
                    <button id="playChord" class="primary">Play Chord</button>
                </div>
            </div>
        </section>

        <section class="section" id="panel-ear" style="display:none">
            <h3>Ear Training</h3>
            <div class="row" id="earFeedback" style="margin-top:0.5rem;color:var(--muted)">Press <b>Play Prompt</b> to
                start.</div>
            <div class="section-cont">
                <div class="row" style="margin-top:0.5rem">
                    <div class="pill">‚≠ê<b id="earScore">0</b></div>
                    <div class="pill">üìà<b id="earStreak">0</b></div>
                    <div class="pill">üèÜ<b id="earBest">0</b></div>
                </div>
                <div class="row" id="earChoices" style="margin-top:0.5rem"></div>
                <div class="row">
                    <label>Mode</label>
                    <select id="earMode">
                        <option value="note">Note ID (single)</option>
                        <option value="interval">Interval ID</option>
                        <option value="chord">Chord Quality ID</option>
                        <option value="scale">Scale Type ID</option>
                    </select>
                    <button id="earReveal">Reveal</button>
                    <button id="earReplay">üîÑÔ∏è Replay</button>
                    <button id="earPlay" class="primary">Play Prompt</button>
                </div>
            </div>

        </section>

        <section class="section" id="panel-demo" style="display:none">
            <h3>Demo Songs (MIDI-like)</h3>
            <div class="row" style="margin-top:0.5rem;color:var(--muted)">Simple melodies arranged for sine/square
                waves.
                Use BPM to change speed.
            </div>
            <div class="section-cont">
                <div class="row" style="margin-top: 0.5rem;">
                    <div class="pill" style="color:#151515;background-color:#626262;">Upload MIDI (wip)</div>
                </div>
                <div class="row">
                    <label>Song</label>
                    <select id="demoSong"></select>
                    <span>
                        <button id="bpmBtn" type="button" style="min-width:5rem"></button>
                        <input id="bpm" type="number" min="40" max="240" value="120" style="width:5rem;display:none">
                    </span>
                    <button id="demoStop">Stop</button>
                    <button id="demoPlay" class="primary">Play</button>
                </div>
            </div>
        </section>
    </main>

    <!-- PANEL BOTTOM: Piano -->
    <div class="piano-wrap">
        <div class="piano-toolbar">
            <div class="row">
                <button id="sustain">Sustain: Off</button>
                <span class="pilltransparent"><span style="opacity:.7">Start</span>
                    <select id="rangeStart"></select>
                </span>
                <span class="pilltransparent"><span style="opacity:.7">End</span>
                    <select id="rangeEnd"></select>
                </span>
                <button id="applyRange">Apply Range</button>
            </div>
            <div class="row">
                <span>
                    <button id="volumeBtn" type="button" style="min-width:5rem"></button>
                    <input id="volume" type="range" min="0" max="1" step="0.01" value="0.4"
                        style="width:5rem;display:none">
                </span>
                <span>
                    <button id="waveBtn" type="button" style="min-width:5rem"></button>
                    <select id="waveType" style="display:none">
                        <option value="sine">sine</option>
                        <option value="triangle">triangle</option>
                        <option value="square">square</option>
                        <option value="sawtooth">sawtooth</option>
                    </select>
                </span>
                <button id="stopAllNotes">Suspend</button>

            </div>
            <!-- <div class='row'>
                <button id="clearHighlights">Clear Highlights</button>
            </div> -->
        </div>
        <div class="piano-viewport">
            <div id="piano" class="piano" aria-label="Interactive Piano Keyboard"></div>
        </div>
    </div>

    <div class="footer" style="max-width:1200px;margin:0 auto 24px;color:#93a0ff66;text-align:center;font-size:12px">
        Computer keys: Z S X D C V G B H N J M<br>Headphones help with interval/chord clarity.<br>Built with the Web
        Audio API.</div>

    <script>
        (function () {
            'use strict';

            // ===== Error Guard (ignore MetaMask/provider noise) =====
            const errorLog = [];
            function logError(msg) { errorLog.push(msg); }
            window.addEventListener('error', (e) => { const t = e?.message ? String(e.message) : String(e); if (/metamask|ethereum/i.test(t)) { e.preventDefault(); logError('Ignored extension error: ' + t); return; } logError('Error: ' + t); });
            window.addEventListener('unhandledrejection', (e) => { const t = e?.reason ? (e.reason.message || String(e.reason)) : 'unhandledrejection'; if (/metamask|ethereum/i.test(t)) { e.preventDefault(); logError('Ignored extension rejection: ' + t); return; } logError('Unhandled: ' + t); });

            // ===== Music math =====
            const A4 = 440, A4_MIDI = 69; const NOTES = ["C", "C#", "D", "D#", "E", "F", "F#", "G", "G#", "A", "A#", "B"]; const WHITE = new Set(["C", "D", "E", "F", "G", "A", "B"]);
            function midiToFreq(m) { return +(A4 * Math.pow(2, (m - A4_MIDI) / 12)).toFixed(4) }
            function nameToMidi(name, octave) { const i = NOTES.indexOf(name); if (i < 0) throw new Error('Invalid note ' + name); return (octave + 1) * 12 + i }
            function midiName(m) { const n = NOTES[m % 12]; const o = Math.floor(m / 12) - 1; return n + o }

            // ===== Web Audio =====
            // --- MIDI2 style note management ---
            const AudioCtx = window.AudioContext || window.webkitAudioContext;
            let ctx, masterGain;
            const activeVoices = new Map();
            function ensureCtx() {
                if (!ctx) {
                    ctx = new AudioCtx();
                    masterGain = ctx.createGain();
                    masterGain.gain.value = +volume.value;
                    masterGain.connect(ctx.destination);
                }
                if (ctx.state === 'suspended') { ctx.resume().catch(() => { }); }
            }
            function noteOn(midi, dur = 0.6) {
                ensureCtx();
                const now = ctx.currentTime;
                const osc = ctx.createOscillator();
                const osc2 = ctx.createOscillator();
                const g = ctx.createGain();
                const mix = ctx.createGain();
                // Use selected waveType for both oscillators
                const wave = waveType && waveType.value ? waveType.value : 'sine';
                osc.type = wave;
                osc2.type = wave;
                osc.frequency.value = midiToFreq(midi);
                osc2.frequency.value = midiToFreq(midi) * 2;
                mix.gain.value = 0.35;
                osc.connect(mix);
                osc2.connect(mix);
                const filt = ctx.createBiquadFilter();
                filt.type = 'lowpass';
                filt.frequency.value = 6000;
                mix.connect(filt);
                filt.connect(g);
                g.connect(masterGain);
                // Envelope
                const atk = 0.01, dec = 0.12, sus = 0.6, rel = 0.3;
                g.gain.setValueAtTime(0, now);
                g.gain.linearRampToValueAtTime(1, now + atk);
                g.gain.linearRampToValueAtTime(sus, now + atk + dec);
                osc.start(now);
                osc2.start(now);
                activeVoices.set(midi, { osc, osc2, g, rel });
                // Auto stop if no sustain
                if (!sustainOn) {
                    stopAt(midi, now + dur);
                }
            }
            function stopAt(midi, t) {
                const v = activeVoices.get(midi);
                if (!v) return;
                const off = Math.max(ctx.currentTime, t);
                v.gain = v.g;
                v.gain.gain.cancelScheduledValues(ctx.currentTime);
                v.gain.gain.setTargetAtTime(0, off, v.rel);
                try {
                    v.osc.stop(off + v.rel * 2);
                    v.osc2.stop(off + v.rel * 2);
                } catch (e) { }
                setTimeout(() => activeVoices.delete(midi), 1200);
            }
            function noteOff(midi) {
                stopAt(midi, ctx.currentTime);
            }
            function stopAllNotes() {
                // Stop all notes and clear sustain
                for (const [m, v] of activeVoices) stopAt(m, ctx.currentTime);
                sustainOn = false;
                const sustainBtn = document.getElementById('sustain');
                if (sustainBtn) sustainBtn.textContent = 'Sustain: Off';
            }

            // ===== Piano rendering with range & marking =====
            const pianoEl = document.getElementById('piano');
            const DEFAULT_FROM = nameToMidi('C', 3); // C3 (48)
            const DEFAULT_TO = nameToMidi('C', 6);   // C6 (84) ‚Üí 37 keys inclusive
            let range = { from: DEFAULT_FROM, to: DEFAULT_TO };

            function renderPiano() {
                pianoEl.innerHTML = '';
                // build lists of white and black midi numbers
                const whites = [];
                const blacks = [];
                for (let m = range.from; m <= range.to; m++) {
                    const n = NOTES[m % 12];
                    if (WHITE.has(n)) whites.push(m);
                    else blacks.push(m);
                }

                // Responsive: white keys fill .piano width
                const pianoWidth = pianoEl.clientWidth || pianoEl.parentElement.clientWidth;
                const keyWidth = pianoWidth / whites.length;
                const blackWidth = Math.round(keyWidth * 0.65);

                // create white keys and map index
                const whiteIndexMap = {};
                whites.forEach((wm, i) => {
                    const w = document.createElement('div');
                    w.className = 'white';
                    w.dataset.midi = wm;
                    w.style.width = keyWidth + 'px';
                    const lab = document.createElement('div');
                    lab.className = 'label';
                    lab.textContent = midiName(wm);
                    w.appendChild(lab);
                    pianoEl.appendChild(w);
                    whiteIndexMap[wm] = i;
                });

                // create black keys positioned relative to piano container (above whites)
                blacks.forEach(bm => {
                    // find previous white (bm-1) which should exist
                    const prevWhite = bm - 1;
                    let wi = whiteIndexMap[prevWhite];
                    if (wi === undefined) {
                        // fallback: try find nearest white index
                        const keys = Object.keys(whiteIndexMap).map(k => +k).sort((a, b) => a - b);
                        let j = 0;
                        while (j < keys.length && keys[j] < bm) j++;
                        wi = Math.max(0, j - 1);
                    }
                    const left = wi * keyWidth + keyWidth - Math.round(blackWidth / 2);
                    const b = document.createElement('div');
                    b.className = 'black';
                    b.dataset.midi = bm;
                    b.style.width = blackWidth + 'px';
                    b.style.left = left + 'px';
                    b.style.top = '0px';
                    b.style.zIndex = 3;
                    pianoEl.appendChild(b);
                });
            }
            // Remove broken/duplicate stopAllNotes. Use the correct one below.
            function clearHighlights() {
                // Do nothing: disables highlight and note-dot UI, but keeps logic for playback
                // (Chord/scale/demo will still work, but no highlight/note-dot will show)
            }
            function markMidi(midi) {
                // Show .active state for the key (white or black) for 50ms
                const keyEl = pianoEl.querySelector(`[data-midi="${midi}"]`);
                if (!keyEl) return;
                keyEl.classList.add('active');
                setTimeout(() => keyEl.classList.remove('active'), 200);
            }
            function highlightMidis(midis) {
                // clearHighlights();
                midis.forEach(m => markMidi(m));
                // if (midis && midis.length > 0) {
                //     setTimeout(() => clearHighlights(), 100);
                // }
            }

            // Mouse interactions (DO NOT highlight on manual play)
            let sustainOn = false;
            pianoEl.addEventListener('mousedown', e => { const key = e.target.closest('[data-midi]'); if (!key) return; key.classList.add('active'); noteOn(+key.dataset.midi); });
            pianoEl.addEventListener('mouseup', e => { const key = e.target.closest('[data-midi]'); if (!key) return; key.classList.remove('active'); noteOff(+key.dataset.midi); });
            pianoEl.addEventListener('mouseleave', () => { pianoEl.querySelectorAll('.active').forEach(k => { k.classList.remove('active'); if (!sustainOn) noteOff(+k.dataset.midi); }); });

            // Fix: Clear Highlights button
            // document.getElementById('clearHighlights').onclick = clearHighlights;

            // Keyboard mapping (DO NOT highlight on manual keyboard play)
            let baseOct = 4; const map = { 'z': 0, 's': 1, 'x': 2, 'd': 3, 'c': 4, 'v': 5, 'g': 6, 'b': 7, 'h': 8, 'n': 9, 'j': 10, 'm': 11 };
            window.addEventListener('keydown', e => { if (e.repeat) return; if (e.key === 'ArrowLeft') { baseOct = Math.max(1, baseOct - 1); return } if (e.key === 'ArrowRight') { baseOct = Math.min(7, baseOct + 1); return } const s = map[e.key.toLowerCase()]; if (s == null) return; const midi = nameToMidi(NOTES[s], baseOct); noteOn(midi); const el = pianoEl.querySelector(`[data-midi="${midi}"]`); if (el) { el.classList.add('active'); } });
            window.addEventListener('keyup', e => { const s = map[e.key.toLowerCase()]; if (s == null) return; const midi = nameToMidi(NOTES[s], baseOct); noteOff(midi); const el = pianoEl.querySelector(`[data-midi="${midi}"]`); if (el) el.classList.remove('active'); });

            // Controls (top shared)
            const waveType = document.getElementById('waveType');
            const waveBtn = document.getElementById('waveBtn');
            const volume = document.getElementById('volume');
            const volumeBtn = document.getElementById('volumeBtn');
            const bpmInput = document.getElementById('bpm');
            const bpmBtn = document.getElementById('bpmBtn');

            // BPM
            function updateBpmBtn() { bpmBtn.textContent = bpmInput.value + ' BPM'; }
            updateBpmBtn();
            bpmBtn.addEventListener('click', () => {
                bpmBtn.style.display = 'none';
                bpmInput.style.display = '';
                bpmInput.focus();
                bpmInput.select();
            });
            function hideBpmInput() {
                bpmInput.style.display = 'none';
                bpmBtn.style.display = '';
                updateBpmBtn();
            }
            bpmInput.addEventListener('blur', hideBpmInput);
            bpmInput.addEventListener('keydown', e => {
                if (e.key === 'Enter') {
                    hideBpmInput();
                }
            });
            bpmInput.addEventListener('input', updateBpmBtn);

            // Volume
            function updateVolumeBtn() { volumeBtn.textContent = 'Volume: ' + Math.round(volume.value * 100); }
            updateVolumeBtn();
            volumeBtn.addEventListener('click', () => {
                volumeBtn.style.display = 'none';
                volume.style.display = '';
                volume.focus();
            });
            function hideVolumeInput() {
                volume.style.display = 'none';
                volumeBtn.style.display = '';
                updateVolumeBtn();
            }
            volume.addEventListener('blur', hideVolumeInput);
            volume.addEventListener('keydown', e => {
                if (e.key === 'Enter') {
                    hideVolumeInput();
                }
            });
            volume.addEventListener('input', updateVolumeBtn);
            volume.addEventListener('input', () => { ensureCtx(); masterGain.gain.value = +volume.value; localStorage.setItem('mtt_vol', volume.value) });

            // Wave
            function updateWaveBtn() { waveBtn.textContent = 'Wave: ' + waveType.value; }
            updateWaveBtn();
            waveBtn.addEventListener('click', () => {
                waveBtn.style.display = 'none';
                waveType.style.display = '';
                waveType.focus();
            });
            function hideWaveInput() {
                waveType.style.display = 'none';
                waveBtn.style.display = '';
                updateWaveBtn();
            }
            waveType.addEventListener('blur', hideWaveInput);
            waveType.addEventListener('change', hideWaveInput);
            document.getElementById('sustain').onclick = function () { sustainOn = !sustainOn; this.textContent = 'Sustain: ' + (sustainOn ? 'On' : 'Off') };
            // Sustain button: when turning off, stop all sustained notes
            document.getElementById('sustain').onclick = function () {
                sustainOn = !sustainOn;
                this.textContent = 'Sustain: ' + (sustainOn ? 'On' : 'Off');
                if (!sustainOn) {
                    // Stop all currently held notes
                    for (const [m, v] of activeVoices) stopAt(m, ctx.currentTime);
                }
            };
            // Suspend button: stop all notes
            document.getElementById('stopAllNotes').onclick = function () {
                stopAllNotes();
            };

            // Tabs
            const panels = { notes: document.getElementById('panel-notes'), scales: document.getElementById('panel-scales'), chords: document.getElementById('panel-chords'), ear: document.getElementById('panel-ear'), demo: document.getElementById('panel-demo') };
            document.querySelectorAll('.tab').forEach(tab => { tab.addEventListener('click', () => { document.querySelectorAll('.tab').forEach(t => t.classList.remove('active')); tab.classList.add('active'); Object.values(panels).forEach(p => p.style.display = 'none'); panels[tab.dataset.tab].style.display = 'block'; }); });

            // Populate selects
            const noteSelect = document.getElementById('noteSelect'); const octaveSelect = document.getElementById('octaveSelect'); const scaleRoot = document.getElementById('scaleRoot'); const scaleType = document.getElementById('scaleType'); const chordRoot = document.getElementById('chordRoot'); const chordType = document.getElementById('chordType'); const scaleDir = document.getElementById('scaleDir'); const chordPlay = document.getElementById('chordPlay');
            function fillNotes(sel) { sel.innerHTML = NOTES.map(n => `<option value="${n}">${n}</option>`).join(''); }
            function fillOctaves(sel, from = 1, to = 6) { sel.innerHTML = Array.from({ length: to - from + 1 }, (_, i) => from + i).map(o => `<option value="${o}">${o}</option>`).join(''); }
            fillNotes(noteSelect); fillOctaves(octaveSelect, 1, 7); octaveSelect.value = 4; fillNotes(scaleRoot); fillNotes(chordRoot);

            // Dictionaries
            const SCALES = {
                "Major (Ionian)": [0, 2, 4, 5, 7, 9, 11, 12],
                "Minor (Natural)": [0, 2, 3, 5, 7, 8, 10, 12],
                "Minor (Harmonic)": [0, 2, 3, 5, 7, 8, 11, 12],
                "Minor (Melodic Asc.)": [0, 2, 3, 5, 7, 9, 11, 12],
                "Pentatonic Major": [0, 2, 4, 7, 9, 12],
                "Pentatonic Minor": [0, 3, 5, 7, 10, 12],
                "Blues": [0, 3, 5, 6, 7, 10, 12],
                "Dorian": [0, 2, 3, 5, 7, 9, 10, 12],
                "Mixolydian": [0, 2, 4, 5, 7, 9, 10, 12]
            };
            const CHORDS = {
                "Major": [0, 4, 7],
                "Minor": [0, 3, 7],
                "Diminished": [0, 3, 6],
                "Augmented": [0, 4, 8],
                "Major 7": [0, 4, 7, 11],
                "Dominant 7": [0, 4, 7, 10],
                "Minor 7": [0, 3, 7, 10],
                "Half-diminished 7": [0, 3, 6, 10]
            };
            scaleType.innerHTML = Object.keys(SCALES).map(k => `<option>${k}</option>`).join('');
            chordType.innerHTML = Object.keys(CHORDS).map(k => `<option>${k}</option>`).join('');

            // Notes panel
            const currentNote = document.getElementById('currentNote'); const currentHz = document.getElementById('currentHz'); const currentMidi = document.getElementById('currentMidi');
            function showNote(name, oct) { const midi = nameToMidi(name, +oct); const hz = midiToFreq(midi); currentNote.textContent = name + oct; currentHz.textContent = hz.toFixed(2); currentMidi.textContent = midi; }
            document.getElementById('playNote').onclick = () => { const n = noteSelect.value; const o = +octaveSelect.value; showNote(n, o); const m = nameToMidi(n, o); noteOn(m, 60 / Math.max(40, +bpm.value)); setTimeout(() => { if (!sustainOn) noteOff(m); }, 500); };

            // Scale panel
            const scaleFormula = document.getElementById('scaleFormula'); const bpm = document.getElementById('bpm');
            function buildScale(rootName, rootOct, kind) { const rootMidi = nameToMidi(rootName, rootOct); const intervals = SCALES[kind]; const midis = intervals.map(i => rootMidi + i); scaleFormula.textContent = 'Formula: ' + intervals.join(' '); return midis; }
            document.getElementById('playScale').onclick = async () => { const root = scaleRoot.value; const kind = scaleType.value; const dir = scaleDir.value; const rootOct = 4; let midis = buildScale(root, rootOct, kind); if (dir === 'down') { midis = [...midis].reverse(); } if (dir === 'updown') { midis = [...midis, ...midis.slice(0, -1).reverse()]; } /* highlightMidis(midis); */ const beat = 60 / Math.max(40, +bpm.value); for (const m of midis) { noteOn(m); markMidi(m); await wait(beat * 1000); if (!sustainOn) noteOff(m);} };

            // Chord panel
            const chordFormula = document.getElementById('chordFormula');
            function buildChord(rootName, rootOct, kind) { const rootMidi = nameToMidi(rootName, rootOct); const intervals = CHORDS[kind]; chordFormula.textContent = 'Intervals: ' + intervals.join(' '); return intervals.map(i => rootMidi + i) }
            document.getElementById('playChord').onclick = async () => { const root = chordRoot.value; const kind = chordType.value; const mode = chordPlay.value; const rootOct = 4; const midis = buildChord(root, rootOct, kind); /* highlightMidis(midis); */ const beat = 60 / Math.max(40, +bpm.value); if (mode === 'block') { midis.forEach(m => noteOn(m)); setTimeout(() => { if (!sustainOn) midis.forEach(m => noteOff(m)); }, beat * 1000 * 2); } else if (mode === 'up') { for (const m of midis) { noteOn(m); markMidi(m); await wait(beat * 1000); if (!sustainOn) noteOff(m); } } else { for (const m of [...midis].reverse()) { noteOn(m); await wait(beat * 1000); if (!sustainOn) noteOff(m); markMidi(m); } } };

            // Ear Training panel (+ replay)
            const earMode = document.getElementById('earMode'); const earChoices = document.getElementById('earChoices'); const earFeedback = document.getElementById('earFeedback'); const earScoreEl = document.getElementById('earScore'); const earStreakEl = document.getElementById('earStreak'); const earBestEl = document.getElementById('earBest');
            let earAnswer = null; let lastPrompt = null; let score = +localStorage.getItem('mtt_score') || 0; let streak = +localStorage.getItem('mtt_streak') || 0; let best = +localStorage.getItem('mtt_best') || 0; updateScore();
            function updateScore() { earScoreEl.textContent = score; earStreakEl.textContent = streak; earBestEl.textContent = best; }
            function makeChoices(items, correct) { const uniq = new Set([correct]); while (uniq.size < 4) { uniq.add(items[Math.floor(Math.random() * items.length)]) } const arr = [...uniq].sort(() => Math.random() - .5); earChoices.innerHTML = ''; arr.forEach(x => { const b = document.createElement('button'); b.textContent = x; b.onclick = () => check(x); earChoices.appendChild(b); }); }
            function setPrompt(midis, answer) { lastPrompt = { midis: [...midis], answer }; earAnswer = answer; }

            document.getElementById('earPlay').onclick = () => { playNewPrompt(); };
            document.getElementById('earReplay').onclick = async () => { if (!lastPrompt) { earFeedback.textContent = 'No prompt yet.'; return; } earFeedback.textContent = 'Replay‚Ä¶'; await sequential(lastPrompt.midis, 0.3, false); };
            document.getElementById('earReveal').onclick = () => { if (!earAnswer) { earFeedback.textContent = 'No prompt yet.'; return } earFeedback.innerHTML = `Answer: <b>${earAnswer}</b>`; };

            function playNewPrompt() { const mode = earMode.value; earFeedback.textContent = 'Listen‚Ä¶'; const beat = 60 / Math.max(40, +bpm.value); if (mode === 'note') { const oct = 4; const n = randFrom(NOTES); const m = nameToMidi(n, oct); makeChoices(NOTES, n); setPrompt([m], n); noteOn(m); setTimeout(() => noteOff(m), beat * 800); } else if (mode === 'interval') { const oct = 4; const root = randFrom(NOTES.slice(0, 7)); const intervals = { 'm2': 1, 'M2': 2, 'm3': 3, 'M3': 4, 'P4': 5, 'TT': 6, 'P5': 7, 'm6': 8, 'M6': 9, 'm7': 10, 'M7': 11, 'P8': 12 }; const names = Object.keys(intervals); const ans = randFrom(names); const m1 = nameToMidi(root, oct), m2 = m1 + intervals[ans]; makeChoices(names, ans); setPrompt([m1, m2], ans); sequential([m1, m2], beat, false); } else if (mode === 'chord') { const root = 'C'; const names = Object.keys(CHORDS); const ans = randFrom(names); const midis = buildChord(root, 4, ans); makeChoices(names, ans); setPrompt(midis, ans); playTogether(midis, beat * 2, false); } else { const root = 'C'; const names = Object.keys(SCALES); const ans = randFrom(names); const midis = buildScale(root, 4, ans); makeChoices(names, ans); setPrompt(midis, ans); sequential(midis, beat, false); } }

            function check(choice) { if (!earAnswer) return; if (choice === earAnswer) { earFeedback.innerHTML = '‚úÖ Correct!'; score += 5; streak++; best = Math.max(best, streak); } else { earFeedback.innerHTML = `‚ùå Oops ‚Äî answer was <b>${earAnswer}</b>`; score = Math.max(0, score - 1); streak = 0; } localStorage.setItem('mtt_score', score); localStorage.setItem('mtt_streak', streak); localStorage.setItem('mtt_best', best); updateScore(); earAnswer = null; }

            // Demo songs (very small MIDI-like arrays)
            const demoSelect = document.getElementById('demoSong'); const demoPlay = document.getElementById('demoPlay'); const demoStop = document.getElementById('demoStop');
            const SONGS = {
                'Twinkle Twinkle (C Major)': [
                    { midi: 60, duration: 1 },
                    { midi: 60, duration: 1 },
                    { midi: 67, duration: 1 },
                    { midi: 67, duration: 1 },
                    { midi: 69, duration: 1 },
                    { midi: 69, duration: 1 },
                    { midi: 67, duration: 1 },
                    { midi: -1, duration: 1 },
                    { midi: 65, duration: 1 },
                    { midi: 65, duration: 1 },
                    { midi: 64, duration: 1 },
                    { midi: 64, duration: 1 },
                    { midi: 62, duration: 1 },
                    { midi: 62, duration: 1 },
                    { midi: 60, duration: 1 },
                ],
                'Ode to Joy (excerpt)': [
                    { midi: 64, duration: 1 },
                    { midi: 64, duration: 1 },
                    { midi: 65, duration: 1 },
                    { midi: 67, duration: 1 },
                    { midi: 67, duration: 1 },
                    { midi: 65, duration: 1 },
                    { midi: 64, duration: 1 },
                    { midi: 62, duration: 1 },
                    { midi: 60, duration: 1 },
                    { midi: 60, duration: 1 },
                    { midi: 62, duration: 1 },
                    { midi: 64, duration: 1 },
                    { midi: 64, duration: 1 },
                    { midi: -1, duration: 0.5 },
                    { midi: 62, duration: 0.5 },
                    { midi: 62, duration: 1 },
                ],
                'Happy Birthday (excerpt)': [60, 60, 62, 60, 65, 64, 60, 60, 62, 60, 67, 65]
            };
            demoSelect.innerHTML = Object.keys(SONGS).map(n => `<option>${n}</option>`).join('');
            let demoAbort = false;
            demoPlay.onclick = async () => {
                demoAbort = false; const name = demoSelect.value;
                const seq = SONGS[name];
                const beat = 60 / Math.max(40, +bpm.value);
                for (const note of seq) {
                    if (demoAbort) break;
                    const dur = (note.duration || 1) * beat * 900;
                    if (note.midi != null && note.midi !== -1) {
                        // Clear all previous actives before marking new note
                        pianoEl.querySelectorAll('.active').forEach(k => k.classList.remove('active'));
                        noteOn(note.midi);
                        markMidi(note.midi);
                    }
                    await wait(dur);
                    if (note.midi != null && note.midi !== -1 && !sustainOn) noteOff(note.midi);
                }
            };
            demoStop.onclick = () => { demoAbort = true; stopAllNotes(); };

            // Helpers
            function randFrom(arr) { return arr[Math.floor(Math.random() * arr.length)] }
            function wait(ms) { return new Promise(r => setTimeout(r, ms)) }
            async function sequential(midis, beatSec = 0.3, doHighlight = false) { if (doHighlight) highlightMidis(midis); for (const m of midis) { noteOn(m); await wait(beatSec * 1000); if (!sustainOn) noteOff(m); if (doHighlight) markMidi(m); } }
            function playTogether(midis, durSec = 1.2, doHighlight = false) { if (doHighlight) highlightMidis(midis); midis.forEach(m => noteOn(m)); setTimeout(() => { if (!sustainOn) midis.forEach(m => noteOff(m)); }, durSec * 1000); }

            // Range controls (C1..A7, default C3..C6, horizontal scroll if >37)
            const rangeStart = document.getElementById('rangeStart'); const rangeEnd = document.getElementById('rangeEnd'); const applyRange = document.getElementById('applyRange');
            function allNotesList(fromMidi = 24, toMidi = 105) { // C1..A7
                const out = []; for (let m = fromMidi; m <= toMidi; m++) { const n = NOTES[m % 12]; const o = Math.floor(m / 12) - 1; out.push({ midi: m, label: n + o }); } return out;
            }
            const ALL = allNotesList(24, 105);
            function fillRangeSelects() { rangeStart.innerHTML = ALL.map(x => `<option value="${x.midi}">${x.label}</option>`).join(''); rangeEnd.innerHTML = ALL.map(x => `<option value="${x.midi}">${x.label}</option>`).join(''); rangeStart.value = DEFAULT_FROM; rangeEnd.value = DEFAULT_TO; }
            applyRange.onclick = () => { const from = +rangeStart.value; const to = +rangeEnd.value; if (to < from) { alert('End must be ‚â• Start'); return } range = { from, to }; renderPiano(); };

            // Init
            renderPiano(); fillRangeSelects(); spawnFloatNotes();
            const stored = localStorage.getItem('mtt_vol'); if (stored) { const v = +stored; if (!Number.isNaN(v)) volume.value = v; }

            function spawnFloatNotes() { const host = document.getElementById('floatNotes'); const glyphs = ['‚ô™', '‚ô´', '‚ô¨', '‚ô©', '‚ô≠', '‚ôØ']; for (let i = 0; i < 14; i++) { const s = document.createElement('span'); s.textContent = randFrom(glyphs); s.style.left = Math.random() * 100 + 'vw'; s.style.animationDelay = (Math.random() * -12) + 's'; s.style.fontSize = (14 + Math.random() * 24) + 'px'; host.appendChild(s); } }
        })();
    </script>
</body>

</html>